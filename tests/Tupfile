include_rules

CXXFLAGS += -I$(TUP_CWD)

# Compile Google test library
: foreach gtest/src/gtest_main.cc gtest/src/gtest-all.cc |> !cxx |>
: gtest_main.o gtest-all.o |> !ar |> libgtest_main.a

# Compile individual tests
export PKG_CONFIG_PATH
CXXFLAGS += -I..
LDFLAGS += -pthread -L$(TUP_CWD) -lgtest_main -L../lib
LDLIBS_test_MurmurHash3 = -lcommon

# Tests with one file (no other objects)
TESTS1  = test_lis.cc test_lf_forward_list.cc test_mer_pos_hash.cc 
TESTS1 += test_lis_align.cc test_parsesequence.cc
TESTS1 += test_multiplexer.cc test_MurmurHash3.cc test_super_read_name.cc test_least_square_2d.cc

# Tests with special rule for linking
TESTS2  = test_pb_aligner.cc test_aligner_output.cc test_superread_parser.cc

# Flags specific to some tests
CXXFLAGS += $(JELLYFISH_CFLAGS) -I../include
LDFLAGS += $(JELLYFISH_LIBS)

test_aligner_output = ../src_jf_aligner/pb_aligner.o

: foreach $(TESTS1) |> !cxx |> {tests1}
: foreach {tests1}  | libgtest_main.a ../lib/libcommon.a |> !lxxd |> %B {all_tests}

: foreach $(TESTS2) |> !cxx |>
: test_pb_aligner.o ../src_jf_aligner/pb_aligner.o ../src_jf_aligner/superread_parser.o | libgtest_main.a ../lib/libcommon.a |> !lxxd |> test_pb_aligner {all_tests}
: test_aligner_output.o ../src_jf_aligner/pb_aligner.o ../src_jf_aligner/superread_parser.o | libgtest_main.a ../lib/libcommon.a |> !lxxd |> test_aligner_output {all_tests}
: test_superread_parser.o ../src_jf_aligner/superread_parser.o | libgtest_main.a ../lib/libcommon.a |> !lxxd |> test_superread_parser {all_tests}


: foreach {all_tests} |> ./%f > %o 2>&1 |> %f.log


# CXXFLAGS_test_mer_pos_hash += $(JELLYFISH_CFLAGS)
# LDFLAGS_test_mer_pos_hash += $(JELLYFISH_LIBS)
# CXXFLAGS_test_superread_parser += $(JELLYFISH_CFLAGS)
# LDFLAGS_test_superread_parser += $(JELLYFISH_LIBS)
# CXXFLAGS_test_pb_aligner += $(JELLYFISH_CFLAGS) -I../include
# LDFLAGS_test_pb_aligner += $(JELLYFISH_LIBS)

# : foreach $(TESTS) | libgtest_main.a ../lib/libcommon.a |> !cxxld $(%B_DEP) |> {all_tests}

